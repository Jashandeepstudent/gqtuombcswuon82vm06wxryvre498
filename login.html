<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScalVest – Auth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#0f172a;color:#fff}

.center{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card{
  width:380px;
  background:#111827;
  padding:28px;
  border-radius:18px;
}
h3{margin:0 0 6px}
p{margin:0 0 16px;color:#9ca3af;font-size:14px}

input,button{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:10px;
  border:none;
}
input{background:#1f2937;color:#fff}
button{background:#2563eb;color:#fff;font-weight:600;cursor:pointer}

.alt{text-align:center;font-size:13px}
.alt span{color:#60a5fa;cursor:pointer}

.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}
</style>
</head>

<body>

<div class="center">
  <div class="card">
    <h3 id="title">Create account</h3>
    <p id="subtitle">New to ScalVest</p>

    <input id="loginInput" placeholder="Email or Username">
    <input id="passwordInput" type="password" placeholder="Password">

    <button onclick="emailOrUsername()">Continue</button>

    <p class="alt">
      <span onclick="googleLogin()">Google</span> •
      <span onclick="facebookLogin()">Facebook</span> •
      <span onclick="appleLogin()">Apple</span>
    </p>

    <p class="alt">
      <span onclick="toggleMode()">Switch sign in / sign up</span>
    </p>
  </div>
</div>

<!-- PROFILE SETUP -->
<div class="overlay" id="profileModal">
  <div class="card">
    <h3>Complete your profile</h3>
    <p>One-time setup</p>

    <input id="usernameInput" placeholder="Choose username">
    <input id="setPasswordInput" type="password"
           placeholder="Set password (social login only)">

    <button onclick="saveProfile()">Continue</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain:"scalevest-163a0.firebaseapp.com",
  databaseURL:"https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId:"scalevest-163a0"
});

const auth = firebase.auth();
const db = firebase.database();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let isSignin = false;

/* TOGGLE */
function toggleMode(){
  isSignin = !isSignin;
  title.innerText = isSignin ? "Welcome back" : "Create account";
  subtitle.innerText = isSignin ? "Sign in to continue" : "New to ScalVest";
}

/* EMAIL OR USERNAME LOGIN */
async function emailOrUsername(){
  const id = loginInput.value.trim();
  const pass = passwordInput.value;
  if(!id || !pass) return alert("Fill all fields");

  if(id.includes("@")){
    emailFlow(id, pass);
  } else {
    const snap = await db.ref("users")
      .orderByChild("username")
      .equalTo(id)
      .once("value");

    if(!snap.exists()) return alert("Username not found");
    const email = Object.values(snap.val())[0].email;
    emailFlow(email, pass);
  }
}

function emailFlow(email, pass){
  const fn = isSignin
    ? auth.signInWithEmailAndPassword
    : auth.createUserWithEmailAndPassword;

  fn.call(auth, email, pass)
    .then(res=>{
      if(!res.user.emailVerified){
        res.user.sendEmailVerification();
        alert("Verification email sent");
        auth.signOut();
      }
    })
    .catch(e=>alert(e.message));
}

/* SOCIAL */
function googleLogin(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function facebookLogin(){
  auth.signInWithPopup(new firebase.auth.FacebookAuthProvider());
}
function appleLogin(){
  auth.signInWithPopup(new firebase.auth.OAuthProvider("apple.com"));
}

/* AUTH STATE */
auth.onAuthStateChanged(user=>{
  if(!user) return;

  const provider = user.providerData[0].providerId;
  if(provider==="password" && !user.emailVerified) return;

  const ref = db.ref("users/"+user.uid);
  ref.once("value").then(snap=>{
    if(!snap.exists() || !snap.val().profileCompleted){
      openProfilePopup();
    }else{
      location.href="mainbusinesshub.html";
    }
  });
});

/* PROFILE */
function openProfilePopup(){
  if(auth.currentUser.providerData[0].providerId!=="password"){
    setPasswordInput.style.display="block";
  }
  profileModal.style.display="flex";
}

async function saveProfile(){
  const user = auth.currentUser;
  const username = usernameInput.value.trim();
  const pwd = setPasswordInput.value;

  if(!username) return alert("Username required");

  if(pwd) await user.updatePassword(pwd);

  await db.ref("users/"+user.uid).set({
    uid:user.uid,
    email:user.email,
    username,
    provider:user.providerData[0].providerId,
    profileCompleted:true,
    createdAt:Date.now()
  });

  location.href="mainbusinesshub.html";
}
</script>

</body>
</html>

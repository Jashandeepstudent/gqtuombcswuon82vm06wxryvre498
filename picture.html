<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Inventory Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:#f6f7fb;padding:30px}

/* HEADER */
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;flex-wrap:wrap;gap:15px}
.top h2{margin:0;font-size:26px;font-weight:700}
.top .actions{display:flex;gap:10px;flex-wrap:wrap}
.top button{padding:12px 18px;border:none;border-radius:14px;background:#000;color:#fff;font-weight:600;cursor:pointer}
#scannerModal button:active {
    transform: scale(0.95);
    background: #e5e7eb !important;
}
/* Centers everything on the page */
  body, html {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
    font-family: sans-serif;
  }

  .top {
    padding: 20px;
    text-align: center;
  }
.back-btn {
  /* Gemini's clean, light look */
  background: rgba(255, 255, 255, 0.7); 
  color: #444746; 
  border: 1px solid #c4c7c5;
  padding: 8px 18px;
  border-radius: 20px;
  cursor: pointer;
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(4px); /* Glass effect */
}

.back-btn:hover {
  background: #f0f4f9;
  border-color: #7c3aed; /* Subtle hint of purple */
  color: #7c3aed;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

  /* Container to push the square to the dead center */
  .center-container {
    flex: 1; /* Takes up all remaining vertical space */
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* The Big Square Button */
  .big-square {
    width: 250px;
    height: 250px;
    background-color: #8b5cf6;
    color: white;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
    border: none;
    box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
  }

  .big-square:hover {
    background-color: #7c3aed;
    transform: scale(1.05);
  }

  .big-square i {
    font-size: 50px;
    margin-bottom: 15px;
  }

  .big-square span {
    font-weight: bold;
    font-size: 1.2rem;
  }
/* STATS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
.stat{background:#fff;padding:22px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,.06)}
.stat h3{margin:8px 0 0;font-size:26px}

/* TABLE */
.table{background:#fff;border-radius:22px;box-shadow:0 15px 35px rgba(0,0,0,.08);overflow:hidden}
.head,.row{display:grid;grid-template-columns:2fr 1fr 1fr 2fr;padding:16px 22px;align-items:center}
.head{background:#f1f3f7;font-weight:600}
.row:not(:last-child){border-bottom:1px solid #eee}

/* STATUS */
.status.ok{color:#16a34a}
.status.low{color:#d97706}
.status.out{color:#dc2626}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(8px)}
.modal-box, .manual-modal-box {width:450px;background:#fff;padding:35px;border-radius:30px;text-align:center}

.success-popup {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
  background: #16a34a; color: white; padding: 12px 25px; border-radius: 50px; font-weight: 600; display: none; z-index: 3000;
}
.flash{position:fixed;inset:0;background:rgba(34,197,94,.25);pointer-events:none;z-index:3000;opacity:0;transition:.15s}
.flash.show{opacity:1}
</style>
</head>

<body>

<div id="flash" class="flash"></div>
<div id="successPopup" class="success-popup">Done!</div>

<div class="top">
  <h2>Inventory Picture Adding </h2>
  <div class="actions">
    <a href="inventory.html" class="back-btn">
      ‚¨Ö Back
    </a>
  </div>
</div>
<div class="center-container">
  <div class="big-square" onclick="openCameraForAI()">
    <div style="font-size: 60px;">üì∏</div>
    <span>AI SCAN</span>
  </div>
</div>



<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- CONFIG --- 
firebase.initializeApp({
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0"
});

const db = firebase.database();
let inventory = {}, invRef = db.ref('Businesses');

invRef.on("value", s => { inventory = s.val() || {}; render(); });

// --- AI VISION (FIXED) ---
function openCameraForAI() {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
    input.onchange = (e) => processImage(e.target.files[0]);
    input.click();
}

async function processImage(file) {
    if (!file) return;
    triggerSuccess("AI is Analyzing...");

    try {
        // 1. Shrink image (Essential so it doesn't crash Vercel)
        const base64Data = await toBase64(file);
        const base64Image = base64Data.split(',')[1];

// Replace the old fetch with this absolute URL
const response = await fetch('https://ai-inventory-pro-sigma.vercel.app/api/scan', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ imageBase64: base64Image })
});
        const data = await response.json();
        
        // Safety check: If Vercel or Gemini sent an error
        if (data.error) throw new Error(data.error);

        // 3. Extract the items from the AI response
        const aiText = data.candidates[0].content.parts[0].text;
        const jsonMatch = aiText.match(/\[[\s\S]*\]/);
        if (!jsonMatch) throw new Error("AI could not identify items clearly.");
        
        const items = JSON.parse(jsonMatch[0]);

        // 4. Update your Firebase
        items.forEach(item => {
            invRef.push({
                name: item.name.charAt(0).toUpperCase() + item.name.slice(1),
                quantity: Number(item.qty || item.quantity) || 1
            });
        });

        triggerSuccess(`AI added ${items.length} items!`);
    } catch (err) {
        console.error("AI Error:", err);
        alert("Scan Failed: " + err.message);
    }
}
// --- UI HELPERS ---
function render(){
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML="";
  let lowC=0, outC=0;
  Object.entries(inventory).forEach(([id,p])=>{
    let s="OK", c="ok";
    if(p.quantity <= 0){s="Out"; c="out"; outC++}
    else if(p.quantity < 5){s="Low"; c="low"; lowC++}
    productsDiv.innerHTML+=`<div class="row">
      <div style="font-weight:600">${p.name}</div>
      <div>${p.quantity}</div>
      <div class="status ${c}">${s}</div>
      <div><button onclick="invRef.child('${id}').remove()">üóëÔ∏è</button></div>
    </div>`;
  });
  document.getElementById("total").textContent=Object.keys(inventory).length;
  document.getElementById("low").textContent=lowC;
  document.getElementById("out").textContent=outC;
}

function openManualAdd() { document.getElementById("manualModal").style.display = "flex"; }
function closeManualAdd() { document.getElementById("manualModal").style.display = "none"; }
function saveManual() {
    const n = document.getElementById("m_name").value;
    const q = document.getElementById("m_qty").value;
    if(n && q) {
        invRef.push({ name: n, quantity: Number(q) });
        closeManualAdd();
    }
}

function triggerSuccess(msg) {
  const popup = document.getElementById("successPopup");
  popup.textContent = msg; popup.style.display = "block";
  document.getElementById("flash").classList.add("show");
  setTimeout(() => { popup.style.display = "none"; document.getElementById("flash").classList.remove("show"); }, 3000);
}

const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});
</script>
</body>
</html>

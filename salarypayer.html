
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScaleVest: Salary Payroll</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .employee-card {
            transition: all 0.3s ease;
        }
        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .selected-card {
            border: 2px solid #4F46E5;
            background: rgba(79, 70, 229, 0.05);
        }
        .photo-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin: 10px auto;
        }
        .history-item {
            transition: all 0.2s ease;
        }
        .history-item:hover {
            background: rgba(79, 70, 229, 0.05);
            transform: translateX(5px);
        }
        .payment-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .payment-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .payment-method-toggle {
            display: inline-block;
            margin: 15px 0;
            padding: 10px 20px;
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            color: #4F46E5;
            font-weight: 600;
        }
        .payment-method-toggle:hover {
            background: #e5e7eb;
        }
        .hidden-section {
            display: none;
        }
        .upi-logo {
            width: 80px;
            height: 80px;
            margin: 20px auto;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .modern-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s;
            background: #f9fafb;
        }
        .modern-input:focus {
            outline: none;
            border-color: #4F46E5;
            background: white;
        }
        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        .add-employee-modal {
            max-width: 500px;
            padding: 30px;
        }
        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9fafb;
        }
        .photo-upload-area:hover {
            border-color: #4F46E5;
            background: #f3f4f6;
        }
        .photo-preview-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            border: 4px solid #4F46E5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-slate-50 min-h-screen">
    
    <header class="glass-card shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-indigo-900">ScaleVest</h1>
                    <p class="text-sm text-gray-600">Salary Payroll</p>
                </div>
                <div class="flex gap-2">
                    <button id="historyBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 md:px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        üìä History
                    </button>
                    <button id="addEmployeeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 md:px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        + Add Employee
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 mb-24">
        <div id="welcomeSection" class="glass-card rounded-2xl shadow-xl p-6 md:p-8 mb-8">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Hi, <span id="bossName">Boss</span>! üëã</h2>
            <p class="text-gray-600">Manage your team and process payments seamlessly</p>
        </div>

        <div id="employeeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div id="emptyState" class="glass-card rounded-2xl shadow-xl p-12 text-center hidden">
            <div class="flex justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-32 h-32 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-indigo-900 mb-2">No Employees Registered</h3>
            <p class="text-gray-500 mb-8 max-w-sm mx-auto">No Employees yet, add one to get started.</p>
            <button class="add-first-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transition duration-300 transform hover:scale-105 flex items-center mx-auto gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
                </svg>
                Add First Employee
            </button>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 glass-card shadow-2xl p-4 z-50">
        <div class="container mx-auto flex justify-center">
            <button id="paySalaryBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-12 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                üí∞ Pay Salary
            </button>
        </div>
    </div>

    <div id="paymentOverlay" class="payment-overlay">
        <div class="payment-card">
            <div id="paymentContent"></div>
        </div>
    </div>

    <script>
const firebaseConfig = {
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0",
  storageBucket: "scalevest-163a0.firebasestorage.app",
  messagingSenderId: "938358950124",
  appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
  measurementId: "G-QD3TWBZHR0"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();
const auth = firebase.auth();

let employees = {};
let selectedEmployees = new Set();
let employeeDeductions = {};
let bossName = "Boss";
let currentBossId = null;
let currentPaymentSession = null;
let bossUPIId = "";

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(amount).replace('‚Çπ', 'Rs. ');
}

auth.onAuthStateChanged((user) => {
    if (!user) {
        alert("Please login first");
        window.location.href = "login.html";
        return;
    }
    currentBossId = user.uid;
    initApp();
});

function initApp() {
    loadBossInfo();
    loadEmployees();
    setupEventListeners();
    showWelcomePopup();
}

async function loadBossInfo() {
    const bossRef = database.ref(`BusinessOwners/${currentBossId}`);
    const snapshot = await bossRef.once('value');
    const data = snapshot.val();
    if (data && data.upiId) {
        bossUPIId = data.upiId;
    } else {
        askForUPIId();
    }
}

async function askForUPIId() {
    const { value: upiId } = await Swal.fire({
        title: 'Setup Your UPI ID',
        text: 'Please enter your UPI ID to receive payments',
        input: 'text',
        inputPlaceholder: 'yourname@paytm',
        allowOutsideClick: false,
        inputValidator: (value) => {
            if (!value) {
                return 'UPI ID is required!';
            }
            if (!value.includes('@')) {
                return 'Invalid UPI ID format!';
            }
        }
    });

    if (upiId) {
        bossUPIId = upiId;
        await database.ref(`BusinessOwners/${currentBossId}/upiId`).set(upiId);
    }
}

function showWelcomePopup() {
    Swal.fire({
        title: `Hi, ${bossName}! üëã`,
        text: "Welcome to ScaleVest. Manage your team and process salaries with ease.",
        icon: "success",
        confirmButtonText: "Let's Get Started",
        confirmButtonColor: "#4F46E5"
    });
}

function loadEmployees() {
    const employeesRef = database.ref(`BusinessOwners/${currentBossId}/employees`);
    employeesRef.on('value', (snapshot) => {
        employees = snapshot.val() || {};
        renderEmployees();
    });
}

function calculateDailySalary(monthlySalary) {
    return monthlySalary / 30;
}

function calculateLeaveDeduction(monthlySalary, leaveDays) {
    return calculateDailySalary(monthlySalary) * leaveDays;
}

function renderEmployees() {
    const grid = document.getElementById('employeeGrid');
    const emptyState = document.getElementById('emptyState');
    const employeeList = Object.entries(employees);
    
    if (employeeList.length === 0) {
        emptyState.classList.remove('hidden');
        grid.innerHTML = '';
    } else {
        emptyState.classList.add('hidden');
        grid.innerHTML = employeeList.map(([id, emp]) => {
            const deductions = employeeDeductions[id] || { leaveDays: 0, flatDeduction: 0, bonus: 0 };
            const leaveDeduction = calculateLeaveDeduction(emp.salary, deductions.leaveDays);
            const totalDeduction = leaveDeduction + deductions.flatDeduction;
            const netAmount = emp.salary + deductions.bonus - totalDeduction;
            const isSelected = selectedEmployees.has(id);
            
            return `
            <div class="employee-card glass-card rounded-2xl shadow-lg p-6 ${isSelected ? 'selected-card' : ''}" onclick="toggleCardSelection('${id}')">
                <div class="flex justify-between mb-2">
                    <button onclick="event.stopPropagation(); editEmployee('${id}')" class="text-indigo-500 hover:text-indigo-700">‚úèÔ∏è Edit</button>
                    <button onclick="event.stopPropagation(); deleteEmployee('${id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è Remove</button>
                </div>
                <div class="flex flex-col items-center mb-4">
                    ${emp.photoURL ? 
                        `<img src="${emp.photoURL}" alt="${emp.name}" class="w-20 h-20 rounded-full object-cover mb-3">` :
                        `<div class="w-20 h-20 bg-gradient-to-br from-indigo-400 to-indigo-600 rounded-full flex items-center justify-center text-white text-3xl font-bold mb-3">
                            ${emp.name.charAt(0).toUpperCase()}
                        </div>`
                    }
                    ${isSelected ? '<div class="text-green-600 font-bold">‚úì Selected</div>' : ''}
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-1 text-center">${emp.name}</h3>
                <p class="text-indigo-600 font-semibold mb-3 text-center">${emp.role}</p>
                <div class="border-t border-gray-200 pt-3">
                    <p class="text-sm text-gray-600 mb-1">Base Salary</p>
                    <p class="text-2xl font-bold text-green-600">${formatCurrency(emp.salary)}</p>
                    ${totalDeduction > 0 ? `
                        <p class="text-sm text-red-600 mt-2">
                            Deductions: -${formatCurrency(totalDeduction)}
                        </p>
                    ` : ''}
                    ${deductions.bonus > 0 ? `
                        <p class="text-sm text-green-600 mt-2">
                            Bonus: +${formatCurrency(deductions.bonus)}
                        </p>
                    ` : ''}
                </div>
                <div class="mt-3 text-xs text-gray-500">
                    <p>üí≥ ${emp.paymentDetails}</p>
                </div>
                <button onclick="event.stopPropagation(); paySingleEmployee('${id}')" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">
                    üí∏ Pay to ${emp.name}
                </button>
            </div>
            `;
        }).join('');
    }
}

function toggleCardSelection(id) {
    if (selectedEmployees.has(id)) {
        selectedEmployees.delete(id);
        delete employeeDeductions[id];
    } else {
        selectedEmployees.add(id);
        if (!employeeDeductions[id]) {
            employeeDeductions[id] = { leaveDays: 0, flatDeduction: 0, bonus: 0 };
        }
    }
    renderEmployees();
}

function setupEventListeners() {
    document.getElementById('addEmployeeBtn').addEventListener('click', showAddEmployeeForm);
    document.querySelector('.add-first-btn')?.addEventListener('click', showAddEmployeeForm);
    document.getElementById('paySalaryBtn').addEventListener('click', handlePaySalary);
    document.getElementById('historyBtn').addEventListener('click', showPaymentHistory);
}

function detectUPIApp(upiId) {
    if (!upiId) return 'upi';
    const lower = upiId.toLowerCase();
    if (lower.includes('paytm')) return 'paytm';
    if (lower.includes('phonepe')) return 'phonepe';
    if (lower.includes('gpay') || lower.includes('google')) return 'gpay';
    return 'upi';
}

function getUPILogo(appType) {
    const logos = {
        'paytm': 'https://upload.wikimedia.org/wikipedia/commons/2/24/Paytm_Logo_%28standalone%29.svg',
        'phonepe': 'https://upload.wikimedia.org/wikipedia/commons/0/04/PhonePe_Logo.png',
        'gpay': 'https://upload.wikimedia.org/wikipedia/commons/f/f2/Google_Pay_Logo.svg',
        'upi': 'https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg'
    };
    return logos[appType] || logos['upi'];
}

async function paySingleEmployee(empId) {
    const emp = employees[empId];
    
    const { value: formValues } = await Swal.fire({
        title: `Pay ${emp.name}`,
        html: `
            <div style="text-align: left;">
                <p class="text-sm text-gray-600 mb-4">Base Salary: ${formatCurrency(emp.salary)}</p>
                
                <label class="input-label">Bonus Amount</label>
                <input id="bonus" type="number" min="0" class="modern-input" value="0" placeholder="0">
                
                <label class="input-label" style="margin-top: 15px;">Days of Leave</label>
                <input id="leaveDays" type="number" min="0" max="30" class="modern-input" value="0" placeholder="0">
                
                <label class="input-label" style="margin-top: 15px;">Flat Deduction</label>
                <input id="flatDeduction" type="number" min="0" class="modern-input" value="0" placeholder="Loans, penalties, etc.">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Continue to Payment',
        confirmButtonColor: '#10B981',
        customClass: {
            popup: 'add-employee-modal'
        },
        preConfirm: () => ({
            bonus: parseFloat(document.getElementById('bonus').value) || 0,
            leaveDays: parseFloat(document.getElementById('leaveDays').value) || 0,
            flatDeduction: parseFloat(document.getElementById('flatDeduction').value) || 0
        })
    });

    if (formValues) {
        const leaveDeduction = calculateLeaveDeduction(emp.salary, formValues.leaveDays);
        const totalDeduction = leaveDeduction + formValues.flatDeduction;
        const netAmount = emp.salary + formValues.bonus - totalDeduction;

        const paymentData = {
            employeeId: empId,
            employeeName: emp.name,
            employeeRole: emp.role,
            baseSalary: emp.salary,
            bonus: formValues.bonus,
            leaveDays: formValues.leaveDays,
            leaveDeduction: leaveDeduction,
            flatDeduction: formValues.flatDeduction,
            totalDeduction: totalDeduction,
            netAmount: netAmount,
            paymentDetails: emp.paymentDetails
        };

        initiateUPIPayment([paymentData]);
    }
}

async function handlePaySalary() {
    const employeeCount = Object.keys(employees).length;
    
    if (employeeCount === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'No Employees',
            text: 'Please add employees first!',
            confirmButtonColor: '#4F46E5'
        });
        return;
    }

    if (selectedEmployees.size > 0) {
        await askForAdjustments();
        return;
    }

    const { value: choice } = await Swal.fire({
        title: 'Pay Salary',
        text: 'How would you like to proceed?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Pay All Employees',
        cancelButtonText: 'Select Employees',
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#4F46E5',
        reverseButtons: true
    });

    if (choice) {
        await askForGlobalDeductions();
    } else if (choice === false) {
        selectedEmployees.clear();
        employeeDeductions = {};
        renderEmployees();
        
        Swal.fire({
            title: 'Select Employees',
            text: 'Click on employee cards to select them',
            icon: 'info',
            confirmButtonText: 'Continue to Payment',
            confirmButtonColor: '#4F46E5'
        }).then(async (result) => {
            if (result.isConfirmed && selectedEmployees.size > 0) {
                await askForAdjustments();
            } else if (result.isConfirmed && selectedEmployees.size === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Selection',
                    text: 'Please select at least one employee',
                    confirmButtonColor: '#4F46E5'
                });
            }
        });
    }
}

async function askForGlobalDeductions() {
    const { value: formValues } = await Swal.fire({
        title: 'Global Adjustments',
        html: `
            <div style="text-align: left;">
                <p class="text-sm text-gray-600 mb-4">Apply the same adjustments to all employees</p>
                
                <label class="input-label">Bonus (for all)</label>
                <input id="globalBonus" type="number" min="0" class="modern-input" value="0" placeholder="0">
                
                <label class="input-label" style="margin-top: 15px;">Days of Leave (for all)</label>
                <input id="globalLeave" type="number" min="0" max="30" class="modern-input" value="0" placeholder="0">
                
                <label class="input-label" style="margin-top: 15px;">Flat Deduction (for all)</label>
                <input id="globalFlat" type="number" min="0" class="modern-input" value="0" placeholder="0">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Continue',
        confirmButtonColor: '#4F46E5',
        customClass: {
            popup: 'add-employee-modal'
        },
        preConfirm: () => ({
            bonus: parseFloat(document.getElementById('globalBonus').value) || 0,
            leaveDays: parseFloat(document.getElementById('globalLeave').value) || 0,
            flatDeduction: parseFloat(document.getElementById('globalFlat').value) || 0
        })
    });

    if (formValues) {
        selectedEmployees = new Set(Object.keys(employees));
        Object.keys(employees).forEach(id => {
            employeeDeductions[id] = {
                bonus: formValues.bonus,
                leaveDays: formValues.leaveDays,
                flatDeduction: formValues.flatDeduction
            };
        });
        renderEmployees();
        await processMultiplePayments();
    }
}

async function askForAdjustments() {
    if (selectedEmployees.size === 0) return;

    const { value: formValues } = await Swal.fire({
        title: 'Adjustments for Selected',
        html: `
            <div style="text-align: left;">
                <p class="text-sm text-gray-600 mb-4">Apply to all selected employees</p>
                
                <label class="input-label">Bonus</label>
                <input id="bonus" type="number" min="0" class="modern-input" value="0" placeholder="0">
                
                <label class="input-label" style="margin-top: 15px;">Days of Leave</label>
                <input id="leaveDays" type="number" min="0" max="30" class="modern-input" value="0" placeholder="0">
                
                <label class="input-label" style="margin-top: 15px;">Flat Deduction</label>
                <input id="flatDeduction" type="number" min="0" class="modern-input" value="0" placeholder="0">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Continue',
        confirmButtonColor: '#4F46E5',
        customClass: {
            popup: 'add-employee-modal'
        },
        preConfirm: () => ({
            bonus: parseFloat(document.getElementById('bonus').value) || 0,
            leaveDays: parseFloat(document.getElementById('leaveDays').value) || 0,
            flatDeduction: parseFloat(document.getElementById('flatDeduction').value) || 0
        })
    });

    if (formValues) {
        selectedEmployees.forEach(id => {
            employeeDeductions[id] = formValues;
        });
        renderEmployees();
        await processMultiplePayments();
    }
}

async function processMultiplePayments() {
    const paymentsData = [];
    
    selectedEmployees.forEach(id => {
        const emp = employees[id];
        const deductions = employeeDeductions[id] || { leaveDays: 0, flatDeduction: 0, bonus: 0 };
        const leaveDeduction = calculateLeaveDeduction(emp.salary, deductions.leaveDays);
        const totalDeduction = leaveDeduction + deductions.flatDeduction;
        const netAmount = emp.salary + deductions.bonus - totalDeduction;
        
        paymentsData.push({
            employeeId: id,
            employeeName: emp.name,
            employeeRole: emp.role,
            baseSalary: emp.salary,
            bonus: deductions.bonus,
            leaveDays: deductions.leaveDays,
            leaveDeduction: leaveDeduction,
            flatDeduction: deductions.flatDeduction,
            totalDeduction: totalDeduction,
            netAmount: netAmount,
            paymentDetails: emp.paymentDetails
        });
    });

    initiateUPIPayment(paymentsData);
}

async function initiateUPIPayment(paymentsData) {
    const sessionId = Date.now().toString();
    currentPaymentSession = {
        sessionId: sessionId,
        payments: paymentsData,
        currentIndex: 0,
        completedPayments: []
    };

    await database.ref(`BusinessOwners/${currentBossId}/pendingSessions/${sessionId}`).set({
        createdAt: new Date().toISOString(),
        payments: paymentsData,
        status: 'pending'
    });

    processNextPayment();
}

function processNextPayment() {
    const session = currentPaymentSession;
    if (session.currentIndex >= session.payments.length) {
        showAllPaymentsComplete();
        return;
    }

    const payment = session.payments[session.currentIndex];
    showPaymentScreen(payment);
}

function showPaymentScreen(payment) {
    const overlay = document.getElementById('paymentOverlay');
    const content = document.getElementById('paymentContent');
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    let upiId = payment.paymentDetails.includes('@') ? payment.paymentDetails : bossUPIId;
    const appType = detectUPIApp(upiId);
    const logoUrl = getUPILogo(appType);
    
    content.innerHTML = `
        <div class="mb-6">
            <div class="w-24 h-24 bg-gradient-to-br from-indigo-400 to-indigo-600 rounded-full flex items-center justify-center text-white text-4xl font-bold mx-auto mb-4">
                ${payment.employeeName.charAt(0).toUpperCase()}
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${payment.employeeName}</h2>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-gray-600">Amount to Pay</p>
                <p class="text-3xl font-bold text-green-600">${formatCurrency(payment.netAmount)}</p>
            </div>
        </div>
        
        <div id="statusContainer">
            ${isMobile ? `
                <img src="${logoUrl}" alt="UPI App" class="upi-logo">
                <p class="text-sm text-gray-500 mb-2">Opening UPI app in...</p>
                <div id="timerText" class="text-3xl font-bold text-indigo-600 mb-6">3</div>
            ` : `
                <p class="text-sm text-gray-500 mb-6">Generating QR Code...</p>
            `}
        </div>
    `;
    
    overlay.style.display = 'flex';
    
    if (isMobile) {
        let countdown = 3;
        const timerInterval = setInterval(() => {
            countdown--;
            const timerEl = document.getElementById('timerText');
            if (timerEl) timerEl.textContent = countdown;
            
            if (countdown === 0) {
                clearInterval(timerInterval);
                openUPIApp(payment);
            }
        }, 1000);
    } else {
        setTimeout(() => {
            openUPIApp(payment);
        }, 500);
    }
}

function openUPIApp(payment) {
    let upiId = payment.paymentDetails.includes('@') ? payment.paymentDetails : bossUPIId;
    upiId = upiId.trim().replace(/\s/g, ''); 
    const amount = payment.netAmount.toFixed(2);
    const payeeName = payment.employeeName.trim();
    const note = encodeURIComponent(`Salary for ${payeeName}`);
    const upiLink = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=${note}`;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        window.location.href = upiLink;
        setTimeout(() => {
            showPaymentConfirmation(payment);
        }, 2000);
    } else {
        const statusContainer = document.getElementById('statusContainer');
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upiLink)}`;
        
        statusContainer.innerHTML = `
            <div class="p-2">
                <img src="${qrCodeUrl}" alt="UPI QR" class="mx-auto mb-4 border-4 border-indigo-100 shadow-lg rounded-lg">
                <p class="text-xs text-gray-500 mb-4">Scan with PhonePe, GPay, or Paytm</p>
                <button onclick="showPaymentConfirmation(${JSON.stringify(payment).replace(/"/g, '&quot;')})" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition">
                    I Have Paid ‚úì
                </button>
            </div>
        `;
    }
}

function showPaymentConfirmation(payment) {
    const content = document.getElementById('paymentContent');
    
    content.innerHTML = `
        <div class="mb-6">
            <div class="w-24 h-24 bg-gradient-to-br from-indigo-400 to-indigo-600 rounded-full flex items-center justify-center text-white text-4xl font-bold mx-auto mb-4">
                ${payment.employeeName.charAt(0).toUpperCase()}
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${payment.employeeName}</h2>
            <p class="text-3xl font-bold text-green-600 mb-6">${formatCurrency(payment.netAmount)}</p>
        </div>
        
        <div class="mb-6">
            <p class="text-lg font-semibold text-gray-700 mb-4">Did you complete the payment?</p>
            <p class="text-sm text-gray-500 mb-6">Please confirm only after successful payment</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="confirmPaymentMade('${payment.employeeId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg transition">
                ‚úì Yes, I Paid
            </button>
            <button onclick="paymentNotMade()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg transition">
                ‚úó Not Yet
            </button>
        </div>
    `;
}

window.confirmPaymentMade = async function(employeeId) {
    const { value: transactionDetails } = await Swal.fire({
        title: 'Payment Verification',
        html: `
            <div style="text-align: left;">
                <p class="text-sm text-gray-600 mb-4">Please provide payment details for verification</p>
                
                <label class="input-label">Your UPI ID (Payer)</label>
                <input id="payerUPI" class="modern-input" placeholder="yourname@paytm" required>
                
                <label class="input-label" style="margin-top: 15px;">Payment Method</label>
                <select id="paymentMethod" class="modern-input">
                    <option value="UPI">UPI</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                </select>
                
                <label class="input-label" style="margin-top: 15px;">Transaction ID / Reference No.</label>
                <input id="txnId" class="modern-input" placeholder="Enter transaction ID" required>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Confirm Payment',
        confirmButtonColor: '#10B981',
        customClass: {
            popup: 'add-employee-modal'
        },
        preConfirm: () => {
            const payerUPI = document.getElementById('payerUPI').value;
            const txnId = document.getElementById('txnId').value;
            
            if (!payerUPI || !txnId) {
                Swal.showValidationMessage('Please fill all fields');
                return false;
            }
            
            return {
                payerUPI: payerUPI,
                paymentMethod: document.getElementById('paymentMethod').value,
                transactionId: txnId,
                timestamp: new Date().toISOString()
            };
        }
    });

    if (transactionDetails) {
        const session = currentPaymentSession;
        const payment = session.payments[session.currentIndex];
        
        const completedPayment = {
            ...payment,
            ...transactionDetails,
            paymentDate: new Date().toISOString()
        };
        
        session.completedPayments.push(completedPayment);
        session.currentIndex++;
        
        await savePaymentRecord(completedPayment);
        
        triggerConfetti();
        
        if (session.currentIndex < session.payments.length) {
            setTimeout(() => {
                processNextPayment();
            }, 1500);
        } else {
            showAllPaymentsComplete();
        }
    }
};

window.paymentNotMade = function() {
    Swal.fire({
        icon: 'warning',
        title: 'Payment Not Completed',
        text: 'Please complete the payment in your UPI app first',
        confirmButtonText: 'Try Again',
        confirmButtonColor: '#4F46E5'
    }).then(() => {
        const session = currentPaymentSession;
        const payment = session.payments[session.currentIndex];
        openUPIApp(payment);
    });
};

async function savePaymentRecord(payment) {
    const recordRef = database.ref(`BusinessOwners/${currentBossId}/paymentHistory`).push();
    
    await recordRef.set({
        sessionId: currentPaymentSession.sessionId,
        employeeId: payment.employeeId,
        employeeName: payment.employeeName,
        employeeRole: payment.employeeRole,
        baseSalary: payment.baseSalary,
        bonus: payment.bonus,
        leaveDays: payment.leaveDays,
        leaveDeduction: payment.leaveDeduction,
        flatDeduction: payment.flatDeduction,
        totalDeduction: payment.totalDeduction,
        netAmount: payment.netAmount,
        paymentDetails: payment.paymentDetails,
        payerUPI: payment.payerUPI,
        paymentMethod: payment.paymentMethod,
        transactionId: payment.transactionId,
        paymentDate: payment.paymentDate,
        verificationHash: generateVerificationHash(payment)
    });
}

function generateVerificationHash(payment) {
    const data = `${payment.transactionId}-${payment.employeeId}-${payment.netAmount}-${payment.paymentDate}`;
    return btoa(data);
}

function triggerConfetti() {
    const duration = 2000;
    const end = Date.now() + duration;

    (function frame() {
        confetti({
            particleCount: 3,
            angle: 60,
            spread: 55,
            origin: { x: 0 },
            colors: ['#4F46E5', '#10B981', '#F59E0B']
        });
        confetti({
            particleCount: 3,
            angle: 120,
            spread: 55,
            origin: { x: 1 },
            colors: ['#4F46E5', '#10B981', '#F59E0B']
        });

        if (Date.now() < end) {
            requestAnimationFrame(frame);
        }
    }());
}

async function showAllPaymentsComplete() {
    const overlay = document.getElementById('paymentOverlay');
    overlay.style.display = 'none';
    
    const session = currentPaymentSession;
    const totalPaid = session.completedPayments.reduce((sum, p) => sum + p.netAmount, 0);
    
    await database.ref(`BusinessOwners/${currentBossId}/pendingSessions/${session.sessionId}`).update({
        status: 'completed',
        completedAt: new Date().toISOString()
    });
    
    Swal.fire({
        title: 'üéâ All Payments Completed!',
        html: `
            <div style="text-align: left; padding: 10px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: white;">Payment Summary</h3>
                    <p style="margin: 5px 0; font-size: 1.2em;"><strong>Total Paid:</strong> ${formatCurrency(totalPaid)}</p>
                    <p style="margin: 5px 0;"><strong>Employees:</strong> ${session.completedPayments.length}</p>
                </div>

                <div style="max-height: 300px; overflow-y: auto;">
                    ${session.completedPayments.map((emp, index) => `
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-weight: 600; margin: 0 0 5px 0;">${emp.employeeName}</p>
                                <p style="font-size: 0.85em; color: #64748b; margin: 0;">${formatCurrency(emp.netAmount)} ‚Ä¢ ${emp.paymentMethod}</p>
                            </div>
                            <button onclick="generateEmployeeSlip(${index})" style="background: #4F46E5; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                üìÑ Slip
                            </button>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="generateMasterReceipt()" style="background: #10B981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1;">
                        üì• Download Master Receipt
                    </button>
                </div>
            </div>
        `,
        width: '700px',
        showConfirmButton: true,
        confirmButtonText: 'Done',
        confirmButtonColor: '#4F46E5',
        allowOutsideClick: false
    }).then(() => {
        selectedEmployees.clear();
        employeeDeductions = {};
        currentPaymentSession = null;
        renderEmployees();
    });
    
    window.currentCompletedPayments = session.completedPayments;
}

window.generateEmployeeSlip = function(empIndex) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const payment = window.currentCompletedPayments[empIndex];

    doc.setFillColor(99, 102, 241);
    doc.rect(0, 0, 210, 50, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(26);
    doc.text('SALARY SLIP', 105, 22, { align: 'center' });
    
    doc.setFontSize(11);
    doc.text('ScaleVest Payroll Management', 105, 35, { align: 'center' });

    doc.setFillColor(248, 250, 252);
    doc.rect(15, 60, 180, 50, 'F');
    doc.setDrawColor(79, 70, 229);
    doc.rect(15, 60, 180, 50);

    doc.setTextColor(79, 70, 229);
    doc.setFontSize(12);
    doc.text('EMPLOYEE INFORMATION', 20, 70);

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text('Name:', 20, 82);
    doc.text(payment.employeeName, 65, 82);

    doc.text('Role:', 20, 91);
    doc.text(payment.employeeRole, 65, 91);
    
    doc.text('Payment Date:', 20, 100);
    doc.text(new Date(payment.paymentDate).toLocaleString('en-IN'), 65, 100);

    doc.setFillColor(248, 250, 252);
    doc.rect(15, 120, 180, 40, 'F');
    doc.setDrawColor(79, 70, 229);
    doc.rect(15, 120, 180, 40);

    doc.setTextColor(79, 70, 229);
    doc.setFontSize(12);
    doc.text('PAYMENT DETAILS', 20, 130);

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.text('Transaction ID:', 20, 140);
    doc.text(payment.transactionId, 65, 140);

    doc.text('Payer UPI:', 20, 148);
    doc.text(payment.payerUPI, 65, 148);
    
    doc.text('Payment Method:', 20, 156);
    doc.text(payment.paymentMethod, 65, 156);

    doc.setFillColor(16, 185, 129);
    doc.rect(15, 170, 180, 10, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.text('EARNINGS BREAKDOWN', 20, 177);

    let yPos = 190;
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);

    doc.setFillColor(248, 250, 252);
    doc.rect(15, yPos - 5, 180, 10, 'F');
    doc.text('Base Salary', 20, yPos);
    doc.text('Rs. ' + payment.baseSalary.toLocaleString('en-IN'), 175, yPos, { align: 'right' });
    
    yPos += 10;
    if (payment.bonus > 0) {
        doc.text('Bonus/Incentive', 20, yPos);
        doc.text('Rs. ' + payment.bonus.toLocaleString('en-IN'), 175, yPos, { align: 'right' });
        yPos += 10;
    }

    if (payment.totalDeduction > 0) {
        yPos += 5;
        doc.setFillColor(239, 68, 68);
        doc.rect(15, yPos, 180, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.text('DEDUCTIONS', 20, yPos + 7);
        
        yPos += 15;
        doc.setTextColor(0, 0, 0);
        
        if (payment.leaveDeduction > 0) {
            doc.text('Leave Deduction (' + payment.leaveDays + ' days)', 20, yPos);
            doc.text('-Rs. ' + payment.leaveDeduction.toLocaleString('en-IN'), 175, yPos, { align: 'right' });
            yPos += 10;
        }
        
        if (payment.flatDeduction > 0) {
            doc.text('Other Deductions', 20, yPos);
            doc.text('-Rs. ' + payment.flatDeduction.toLocaleString('en-IN'), 175, yPos, { align: 'right' });
            yPos += 10;
        }
    }

    yPos += 5;
    doc.setLineWidth(1);
    doc.line(15, yPos, 195, yPos);

    yPos += 10;
    doc.setFontSize(14);
    doc.setTextColor(16, 185, 129);
    doc.text('NET SALARY CREDITED', 20, yPos);
    doc.text('Rs. ' + payment.netAmount.toLocaleString('en-IN'), 175, yPos, { align: 'right' });

    yPos += 15;
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139);
    doc.text('Credited to: ' + payment.paymentDetails, 20, yPos);

    yPos = 270;
    doc.setFillColor(79, 70, 229);
    doc.rect(0, yPos, 210, 27, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.text('This is a computer-generated salary slip.', 105, yPos + 8, { align: 'center' });
    doc.text('By ScaleVest Payroll', 105, yPos + 15, { align: 'center' });
    doc.text('Verification Hash: ' + generateVerificationHash(payment).substring(0, 20) + '...', 105, yPos + 20, { align: 'center' });

    doc.save(`SalarySlip_${payment.employeeName.replace(/\s+/g, '_')}_${payment.transactionId}.pdf`);
};

window.generateMasterReceipt = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const payments = window.currentCompletedPayments;
    const totalAmount = payments.reduce((sum, p) => sum + p.netAmount, 0);
    
    doc.setFillColor(79, 70, 229);
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.text('ScaleVest', 105, 18, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text('Payroll Management Platform', 105, 28, { align: 'center' });

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(18);
    doc.text('MASTER PAYMENT RECEIPT', 105, 55, { align: 'center' });

    doc.setFillColor(248, 250, 252);
    doc.rect(15, 65, 180, 30, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(15, 65, 180, 30);

    doc.setFontSize(10);
    doc.text('Session ID:', 20, 73);
    doc.text('Date & Time:', 20, 82);
    doc.text('Total Employees:', 20, 91);

    doc.text(currentPaymentSession.sessionId, 60, 73);
    doc.text(new Date().toLocaleString('en-IN'), 60, 82);
    doc.text(payments.length.toString(), 60, 91);

    doc.setFontSize(14);
    doc.text('Payments Made', 15, 110);

    doc.setFillColor(79, 70, 229);
    doc.rect(15, 115, 180, 8, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.text('Employee', 20, 120);
    doc.text('Method', 80, 120);
    doc.text('Payer UPI', 120, 120);
    doc.text('Amount', 175, 120);

    let yPos = 130;
    doc.setTextColor(0, 0, 0);

    payments.forEach((payment, index) => {
        if (yPos > 270) {
            doc.addPage();
            yPos = 20;
        }

        if (index % 2 === 0) {
            doc.setFillColor(248, 250, 252);
            doc.rect(15, yPos - 5, 180, 8, 'F');
        }

        const nameText = payment.employeeName.substring(0, 15);
        const methodText = payment.paymentMethod;
        const upiText = payment.payerUPI.substring(0, 20);
        const amountText = 'Rs. ' + payment.netAmount.toLocaleString('en-IN');

        doc.text(nameText, 20, yPos);
        doc.text(methodText, 80, yPos);
        doc.text(upiText, 120, yPos);
        doc.text(amountText, 175, yPos);
        
        yPos += 10;
    });

    yPos += 10;
    doc.line(15, yPos, 195, yPos);
    
    yPos += 10;
    doc.setFontSize(12);
    doc.text('TOTAL AMOUNT PAID:', 120, yPos);
    doc.text('Rs. ' + totalAmount.toLocaleString('en-IN'), 175, yPos);

    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    doc.text('This is a computer-generated receipt.', 105, 285, { align: 'center' });
    doc.text('By ScaleVest Payroll', 105, 290, { align: 'center' });

    doc.save(`ScaleVest_MasterReceipt_${currentPaymentSession.sessionId}.pdf`);
};

async function showAddEmployeeForm() {
    const { value: formValues } = await Swal.fire({
        title: 'Add New Employee',
        html: `
            <div style="text-align: left;">
                <label class="input-label">Full Name *</label>
                <input id="empName" class="modern-input" placeholder="John Doe">
                
                <label class="input-label" style="margin-top: 15px;">Role/Position *</label>
                <input id="empRole" class="modern-input" placeholder="Manager, Developer, etc.">
                
                <label class="input-label" style="margin-top: 15px;">Monthly Salary *</label>
                <input id="empSalary" class="modern-input" type="number" placeholder="50000">
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <label class="input-label">üí≥ UPI ID *</label>
                    <input id="empUPI" class="modern-input" placeholder="employee@paytm">
                    
                    <div class="payment-method-toggle" onclick="document.getElementById('bankDetails').classList.toggle('hidden-section')">
                        ‚ûï Or use Bank Account Details
                    </div>
                    
                    <div id="bankDetails" class="hidden-section">
                        <label class="input-label">Bank Account Number</label>
                        <input id="empAcc" class="modern-input" placeholder="1234567890">
                        
                        <label class="input-label" style="margin-top: 15px;">IFSC Code</label>
                        <input id="empIFSC" class="modern-input" placeholder="SBIN0001234">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label class="input-label">üì∏ Employee Photo (Optional)</label>
                    <div class="photo-upload-area" onclick="document.getElementById('empPhoto').click()">
                        <div id="photoPreview"></div>
                        <p style="color: #6b7280; font-size: 0.9em; margin: 10px 0;">Click to upload photo</p>
                        <p style="color: #9ca3af; font-size: 0.75em;">JPG, PNG (Max 5MB)</p>
                    </div>
                    <input id="empPhoto" type="file" accept="image/*" style="display: none;" onchange="previewPhoto(this)">
                </div>
            </div>
        `,
        width: '600px',
        showCancelButton: true,
        confirmButtonText: 'Add Employee',
        confirmButtonColor: '#4F46E5',
        customClass: {
            popup: 'add-employee-modal'
        },
        preConfirm: () => {
            const name = document.getElementById('empName').value;
            const role = document.getElementById('empRole').value;
            const salary = parseFloat(document.getElementById('empSalary').value);
            const upi = document.getElementById('empUPI').value.trim();
            const acc = document.getElementById('empAcc').value.trim();
            const ifsc = document.getElementById('empIFSC').value.trim();

            if (!name || !role || !salary) {
                Swal.showValidationMessage('Please fill all required fields');
                return false;
            }
            
            if (!upi && (!acc || !ifsc)) {
                Swal.showValidationMessage('Provide either UPI ID or Bank Account details');
                return false;
            }

            let paymentDetails = upi;
            if (!upi && acc && ifsc) {
                paymentDetails = `${acc} (IFSC: ${ifsc})`;
            }

            return {
                name: name,
                role: role,
                salary: salary,
                paymentDetails: paymentDetails,
                photo: document.getElementById('empPhoto').files[0]
            };
        }
    });

    if (formValues) await addEmployeeToFirebase(formValues);
}

window.previewPhoto = function(input) {
    const preview = document.getElementById('photoPreview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="photo-preview-large" alt="Preview">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
};


async function addEmployeeToFirebase(employeeData) {
    try {
        Swal.fire({
            title: 'Adding Employee...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        let photoURL = null;

        if (employeeData.photo) {
            const photoRef = storage.ref(`employees/${currentBossId}/${Date.now()}_${employeeData.photo.name}`);
            const snapshot = await photoRef.put(employeeData.photo);
            photoURL = await snapshot.ref.getDownloadURL();
        }

        const employeeRef = database.ref(`BusinessOwners/${currentBossId}/employees`).push();
        
        await employeeRef.set({
            name: employeeData.name,
            role: employeeData.role,
            salary: employeeData.salary,
            paymentDetails: employeeData.paymentDetails,
            photoURL: photoURL,
            createdAt: new Date().toISOString()
        });

        Swal.fire({
            icon: 'success',
            title: 'Employee Added!',
            text: `${employeeData.name} has been added to your team.`,
            confirmButtonColor: '#4F46E5',
            timer: 2000
        });
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to add employee: ' + error.message,
            confirmButtonColor: '#4F46E5'
        });
    }
}

async function showPaymentHistory() {
    const historyRef = database.ref(`BusinessOwners/${currentBossId}/paymentHistory`);
    const snapshot = await historyRef.once('value');
    const historyData = snapshot.val();

    if (!historyData) {
        Swal.fire({
            title: 'No Payment History',
            text: 'You haven\'t made any payments yet.',
            icon: 'info',
            confirmButtonColor: '#4F46E5'
        });
        return;
    }

    const historyArray = Object.entries(historyData).map(([key, value]) => ({
        id: key,
        ...value
    })).sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate));

    const historyHTML = historyArray.map(payment => {
        const date = new Date(payment.paymentDate).toLocaleDateString('en-IN', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        return `
            <div class="history-item" style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p style="font-weight: 600; margin: 0; color: #1f2937;">${payment.employeeName} - ${formatCurrency(payment.netAmount)}</p>
                        <p style="font-size: 0.75em; color: #6b7280; margin: 0;">${payment.paymentMethod} ‚Ä¢ ${date}</p>
                        <p style="font-size: 0.7em; color: #9ca3af; margin: 0;">Txn: ${payment.transactionId}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    Swal.fire({
        title: 'üìä Payment History',
        html: `
            <div style="text-align: left; max-height: 500px; overflow-y: auto; padding: 10px;">
                ${historyHTML}
            </div>
        `,
        width: '600px',
        confirmButtonText: 'Close',
        confirmButtonColor: '#4F46E5'
    });
}

async function deleteEmployee(id) {
    const result = await Swal.fire({
        title: 'Are you sure?',
        text: "This will remove the employee from your records.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        confirmButtonText: 'Yes, delete!'
    });

    if (result.isConfirmed) {
        await database.ref(`BusinessOwners/${currentBossId}/employees/${id}`).remove();
        Swal.fire('Deleted!', 'Employee removed successfully.', 'success');
    }
}

async function editEmployee(id) {
    const emp = employees[id];
    const { value: formValues } = await Swal.fire({
        title: 'Update Employee',
        html: `
            <div style="text-align: left;">
                <input id="editName" class="swal2-input" value="${emp.name}" placeholder="Name">
                <input id="editRole" class="swal2-input" value="${emp.role}" placeholder="Role">
                <input id="editSalary" class="swal2-input" type="number" value="${emp.salary}" placeholder="Salary">
                <input id="editPayment" class="swal2-input" value="${emp.paymentDetails}" placeholder="UPI or Bank Details">
            </div>
        `,
        preConfirm: () => ({
            name: document.getElementById('editName').value,
            role: document.getElementById('editRole').value,
            salary: parseFloat(document.getElementById('editSalary').value),
            paymentDetails: document.getElementById('editPayment').value
        })
    });

    if (formValues) {
        await database.ref(`BusinessOwners/${currentBossId}/employees/${id}`).update(formValues);
        Swal.fire('Updated!', 'Changes saved.', 'success');
    }
}

function showTerms() {
    Swal.fire({
        title: 'Terms & Conditions',
        html: `
            <div style="text-align: left; font-size: 0.85em; max-height: 300px; overflow-y: auto; color: #4b5563;">
                <p><strong>1. Services:</strong> ScaleVest is an ecosystem to Scale. We provide best and revolutionary tools to scale and more for business, startups and investors.</p>
                <p><strong>2. Accuracy:</strong> You are responsible for ensuring all Bank/UPI details are correct. ScaleVest is not responsible for lost funds due to user error.</p>
                <p><strong>3. Compliance:</strong> All payments are subject to UPI transaction terms.</p>
            </div>
        `,
        confirmButtonColor: '#4F46E5'
    });
}

function showPrivacy() {
    Swal.fire({
        title: 'Privacy Policy',
        html: `
            <div style="text-align: left; font-size: 0.85em; max-height: 300px; overflow-y: auto; color: #4b5563;">
                <p><strong>Data Privacy:</strong> ScaleVest takes your data seriously.</p>
                <p><strong>1. Collection:</strong> We store employee names and payment details solely for payroll purposes.</p>
                <p><strong>2. Security:</strong> Your data is protected by Google Firebase encryption.</p>
            </div>
        `,
        confirmButtonColor: '#4F46E5'
    });
}
    </script>

<footer class="mt-12 pb-32 text-center">
    <div class="container mx-auto px-4">
        <div class="glass-card max-w-4xl mx-auto p-8 rounded-2xl shadow-lg border border-indigo-100">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-left">
                <div>
                    <h3 class="text-xl font-bold text-indigo-900 mb-2">ScaleVest</h3>
                    <p class="text-sm text-gray-600">The Digital Brain for Small Business Payroll. A Uniorax Product.</p>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 mb-2">Support</h4>
                    <p class="text-sm text-gray-600">üìß Support: scalevestofficial@gmail.com</p>
                    <p class="text-sm text-gray-600">üìç India</p>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 mb-2">Legal</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li><a href="javascript:void(0)" onclick="showTerms()" class="hover:text-indigo-600 transition">Terms & Conditions</a></li>
                       <li><a href="javascript:void(0)" onclick="showPrivacy()" class="hover:text-indigo-600 transition">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
            <p class="mt-6 text-xs text-gray-400">¬© 2025 UnioraX Private Limited. All rights reserved.</p>
        </div>
    </div>
</footer>
</body>
</html>

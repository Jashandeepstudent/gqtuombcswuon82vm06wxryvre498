import React, { useState, useRef, useEffect } from 'react';
import { Download, Play, Grid, Move, Zap, TrendingUp, AlertTriangle } from 'lucide-react';

const DigitalTwinDashboard = () => {
  const [viewMode, setViewMode] = useState('list');
  const [selectedProducts, setSelectedProducts] = useState([]);
  const [placedBlocks, setPlacedBlocks] = useState([]);
  const [draggedProduct, setDraggedProduct] = useState(null);
  const [simulation, setSimulation] = useState(null);
  const canvasRef = useRef(null);

  const products = [
    { id: 1, name: 'Espresso Blend A', stock: 45, demand: 'High', price: 24.99, velocity: 8.5 },
    { id: 2, name: 'Cold Brew Pack', stock: 12, demand: 'Critical', price: 18.99, velocity: 9.2 },
    { id: 3, name: 'Latte Mix Premium', stock: 67, demand: 'Medium', price: 29.99, velocity: 6.1 },
    { id: 4, name: 'Decaf Reserve', stock: 89, demand: 'Low', price: 22.99, velocity: 3.4 },
    { id: 5, name: 'Mocha Powder Deluxe', stock: 34, demand: 'High', price: 32.99, velocity: 7.8 },
    { id: 6, name: 'Vanilla Syrup Pro', stock: 8, demand: 'Critical', price: 15.99, velocity: 9.5 }
  ];

  const toggleSelection = (product) => {
    setSelectedProducts(prev => {
      const isSelected = prev.find(p => p.id === product.id);
      if (isSelected) {
        return prev.filter(p => p.id !== product.id);
      }
      return [...prev, product];
    });
  };

  const handleCanvasClick = (e) => {
    if (selectedProducts.length === 0) return;
    
    const rect = canvasRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const newBlock = {
      id: Date.now(),
      product: selectedProducts[0],
      x: x - 60,
      y: y - 40,
      width: 120,
      height: 80
    };

    setPlacedBlocks([...placedBlocks, newBlock]);
    setSelectedProducts([]);
  };

  const runSimulation = () => {
    const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
    const avgVelocity = products.reduce((sum, p) => sum + p.velocity, 0) / products.length;
    const criticalItems = products.filter(p => p.demand === 'Critical').length;
    
    const projectedSales = Math.round(avgVelocity * 7 * products.length);
    const restockNeeded = products.filter(p => p.stock < 20).length;
    const revenueProjection = Math.round(projectedSales * 25.5);

    setSimulation({
      currentStock: totalStock,
      projectedWeeklySales: projectedSales,
      restockAlerts: restockNeeded,
      criticalItems: criticalItems,
      revenueProjection: revenueProjection,
      efficiency: Math.round((1 - (criticalItems / products.length)) * 100)
    });
  };

  const generatePDF = () => {
    const timestamp = new Date().toISOString();
    const products_summary = products.map(p => 
      `${String(p.name)} | Stock: ${String(p.stock)} | Demand: ${String(p.demand)} | Velocity: ${String(p.velocity)}`
    ).join('\n');
    
    const layout_info = placedBlocks.map(b => 
      `${String(b.product.name)} at position (${String(Math.round(b.x))}, ${String(Math.round(b.y))})`
    ).join('\n');

    const sim_data = simulation ? `
Stock Level: ${String(simulation.currentStock)}
Projected Sales: ${String(simulation.projectedWeeklySales)}
Restock Alerts: ${String(simulation.restockAlerts)}
Revenue Projection: $${String(simulation.revenueProjection)}
Efficiency: ${String(simulation.efficiency)}%` : 'No simulation run';

    const content = `MORNING BATTLE PLAN
Generated: ${String(timestamp)}

MISSION CRITICAL PRODUCTS:
${products_summary}

SPATIAL LAYOUT:
${layout_info || 'No products placed'}

OPERATIONAL INTELLIGENCE:
${sim_data}

TACTICAL RECOMMENDATIONS:
- Prioritize restocking Critical demand items
- Optimize high-velocity product placement
- Monitor stock levels for sub-20 inventory
- Execute daily velocity analysis`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `battle-plan-${String(Date.now())}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  useEffect(() => {
    if (viewMode === 'spatial' && canvasRef.current) {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');
      
      ctx.fillStyle = '#0a0a0f';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Grid
      ctx.strokeStyle = '#1a1a2e';
      ctx.lineWidth = 1;
      for (let i = 0; i < canvas.width; i += 40) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, canvas.height);
        ctx.stroke();
      }
      for (let i = 0; i < canvas.height; i += 40) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(canvas.width, i);
        ctx.stroke();
      }

      // Blocks
      placedBlocks.forEach(block => {
        const gradient = ctx.createLinearGradient(block.x, block.y, block.x + block.width, block.y + block.height);
        gradient.addColorStop(0, '#4c1d95');
        gradient.addColorStop(1, '#6366f1');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(block.x, block.y, block.width, block.height);
        
        ctx.strokeStyle = '#818cf8';
        ctx.lineWidth = 2;
        ctx.strokeRect(block.x, block.y, block.width, block.height);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px monospace';
        ctx.fillText(block.product.name.substring(0, 15), block.x + 5, block.y + 20);
        ctx.font = '10px monospace';
        ctx.fillText(`Stock: ${String(block.product.stock)}`, block.x + 5, block.y + 40);
        ctx.fillText(`V: ${String(block.product.velocity)}`, block.x + 5, block.y + 55);
      });
    }
  }, [viewMode, placedBlocks]);

  const getDemandColor = (demand) => {
    switch(demand) {
      case 'Critical': return 'border-red-500 bg-red-500/10';
      case 'High': return 'border-orange-500 bg-orange-500/10';
      case 'Medium': return 'border-yellow-500 bg-yellow-500/10';
      default: return 'border-green-500 bg-green-500/10';
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-slate-900 text-white p-6">
      {/* Header */}
      <div className="mb-8 border-b border-indigo-800/30 pb-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent mb-2">
              Digital Twin Control Center
            </h1>
            <p className="text-indigo-300/60 font-mono text-sm">Real-time Operations Command</p>
          </div>
          <div className="flex gap-3">
            <button
              onClick={() => setViewMode(viewMode === 'list' ? 'spatial' : 'list')}
              className="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold flex items-center gap-2 transition-all border border-indigo-400/20 shadow-lg shadow-indigo-500/20"
            >
              {viewMode === 'list' ? <Move className="w-5 h-5" /> : <Grid className="w-5 h-5" />}
              {viewMode === 'list' ? 'Spatial View' : 'List View'}
            </button>
            <button
              onClick={runSimulation}
              className="px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-semibold flex items-center gap-2 transition-all border border-purple-400/20 shadow-lg shadow-purple-500/20"
            >
              <Play className="w-5 h-5" />
              Run Simulation
            </button>
            <button
              onClick={generatePDF}
              className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-lg font-semibold flex items-center gap-2 transition-all border border-emerald-400/20 shadow-lg shadow-emerald-500/20"
            >
              <Download className="w-5 h-5" />
              Battle Plan
            </button>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Product Cards */}
        <div className="lg:col-span-2">
          {viewMode === 'list' ? (
            <div className="space-y-4">
              <h2 className="text-2xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
                <Zap className="w-6 h-6" />
                Product Inventory
              </h2>
              {products.map(product => (
                <div
                  key={product.id}
                  onClick={() => toggleSelection(product)}
                  className={`p-6 rounded-xl border-2 cursor-pointer transition-all backdrop-blur-sm ${
                    selectedProducts.find(p => p.id === product.id)
                      ? 'border-indigo-500 bg-indigo-500/20 shadow-lg shadow-indigo-500/30'
                      : getDemandColor(product.demand)
                  }`}
                >
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="text-xl font-bold text-white">{product.name}</h3>
                      <p className="text-sm text-indigo-300 font-mono mt-1">ID: {product.id}</p>
                    </div>
                    <div className="text-right">
                      <div className={`px-3 py-1 rounded-full text-xs font-bold ${
                        product.demand === 'Critical' ? 'bg-red-500' :
                        product.demand === 'High' ? 'bg-orange-500' :
                        product.demand === 'Medium' ? 'bg-yellow-500' : 'bg-green-500'
                      }`}>
                        {product.demand}
                      </div>
                    </div>
                  </div>
                  <div className="grid grid-cols-4 gap-4 text-sm">
                    <div>
                      <p className="text-indigo-300/60">Stock</p>
                      <p className="text-xl font-bold">{product.stock}</p>
                    </div>
                    <div>
                      <p className="text-indigo-300/60">Price</p>
                      <p className="text-xl font-bold">${product.price}</p>
                    </div>
                    <div>
                      <p className="text-indigo-300/60">Velocity</p>
                      <p className="text-xl font-bold">{product.velocity}</p>
                    </div>
                    <div>
                      <p className="text-indigo-300/60">Value</p>
                      <p className="text-xl font-bold">${Math.round(product.stock * product.price)}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div>
              <h2 className="text-2xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
                <Move className="w-6 h-6" />
                Spatial Layout Designer
              </h2>
              <div className="bg-slate-950/50 rounded-xl p-4 border border-indigo-800/30 backdrop-blur-sm">
                <p className="text-sm text-indigo-300 mb-4">
                  {selectedProducts.length > 0 
                    ? `Click to place: ${selectedProducts[0].name}` 
                    : 'Select a product from the sidebar to place it'}
                </p>
                <canvas
                  ref={canvasRef}
                  width={800}
                  height={600}
                  onClick={handleCanvasClick}
                  className="w-full border-2 border-indigo-700/50 rounded-lg cursor-crosshair"
                />
              </div>
            </div>
          )}
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Quick Select */}
          {viewMode === 'spatial' && (
            <div className="bg-slate-950/50 rounded-xl p-6 border border-indigo-800/30 backdrop-blur-sm">
              <h3 className="text-lg font-bold text-indigo-300 mb-4">Quick Select</h3>
              <div className="space-y-2">
                {products.map(product => (
                  <button
                    key={product.id}
                    onClick={() => toggleSelection(product)}
                    className={`w-full p-3 rounded-lg text-left transition-all border-2 ${
                      selectedProducts.find(p => p.id === product.id)
                        ? 'border-indigo-500 bg-indigo-500/20'
                        : 'border-indigo-800/30 bg-slate-900/50 hover:bg-indigo-900/20'
                    }`}
                  >
                    <p className="font-semibold text-sm">{product.name}</p>
                    <p className="text-xs text-indigo-300/60">Stock: {product.stock}</p>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Simulation Results */}
          {simulation && (
            <div className="bg-slate-950/50 rounded-xl p-6 border border-purple-800/30 backdrop-blur-sm shadow-lg shadow-purple-500/10">
              <h3 className="text-lg font-bold text-purple-300 mb-4 flex items-center gap-2">
                <TrendingUp className="w-5 h-5" />
                Simulation Results
              </h3>
              <div className="space-y-3">
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                  <span className="text-indigo-300/80 text-sm">Current Stock</span>
                  <span className="font-bold text-lg">{simulation.currentStock}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                  <span className="text-indigo-300/80 text-sm">Weekly Sales</span>
                  <span className="font-bold text-lg">{simulation.projectedWeeklySales}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                  <span className="text-indigo-300/80 text-sm">Restock Alerts</span>
                  <span className="font-bold text-lg text-orange-400">{simulation.restockAlerts}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg">
                  <span className="text-indigo-300/80 text-sm">Critical Items</span>
                  <span className="font-bold text-lg text-red-400">{simulation.criticalItems}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-purple-900/30 rounded-lg border border-purple-500/30">
                  <span className="text-purple-300 text-sm font-semibold">Revenue 7d</span>
                  <span className="font-bold text-xl text-emerald-400">${simulation.revenueProjection}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-indigo-900/30 rounded-lg border border-indigo-500/30">
                  <span className="text-indigo-300 text-sm font-semibold">Efficiency</span>
                  <span className="font-bold text-xl">{simulation.efficiency}%</span>
                </div>
              </div>
            </div>
          )}

          {/* System Status */}
          <div className="bg-slate-950/50 rounded-xl p-6 border border-emerald-800/30 backdrop-blur-sm">
            <h3 className="text-lg font-bold text-emerald-300 mb-4">System Status</h3>
            <div className="space-y-3 text-sm">
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                <span className="text-indigo-300/80">Digital Twin: Online</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                <span className="text-indigo-300/80">Simulation Engine: Active</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                <span className="text-indigo-300/80">Blocks Placed: {placedBlocks.length}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default DigitalTwinDashboard;

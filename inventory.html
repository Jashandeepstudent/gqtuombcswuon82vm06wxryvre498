<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Barcode Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #111;
  font-family: Inter, sans-serif;
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

h2 {
  margin-bottom: 10px;
}

#scanner {
  width: 100%;
  max-width: 600px;
  height: 420px;
  border-radius: 18px;
  overflow: hidden;
  position: relative;
  border: 3px solid #00ff55;
}

/* GREEN SCAN ZONE */
.scan-zone {
  position: absolute;
  top: 25%;
  bottom: 25%;
  left: 10%;
  right: 10%;
  border: 3px dashed #00ff55;
  border-radius: 14px;
  z-index: 10;
}

/* LASER LINE */
.laser {
  position: absolute;
  width: 100%;
  height: 3px;
  background: red;
  box-shadow: 0 0 15px red;
  animation: scan 1s linear infinite;
  z-index: 20;
}

@keyframes scan {
  0% { top: 0; }
  50% { top: 100%; }
  100% { top: 0; }
}

#log {
  width: 100%;
  max-width: 600px;
  margin-top: 15px;
  background: #222;
  padding: 12px;
  border-radius: 12px;
  min-height: 120px;
  overflow-y: auto;
}

#log div {
  margin-bottom: 6px;
  font-size: 14px;
}

button {
  margin-top: 15px;
  padding: 12px 18px;
  border-radius: 14px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  background: #00ff55;
  color: black;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>

<body>

<h2>âš¡ AI Barcode Scanner (Super Strong)</h2>

<div id="scanner">
  <div class="scan-zone"></div>
  <div class="laser"></div>
</div>

<div id="log"></div>

<button onclick="startScanner()">START</button>
<button onclick="stopScanner()">STOP</button>

<script>
let scannerRunning = false;
let lastScanTime = 0;
let lastCode = null;

// AI stabilization memory
let aiMemory = {};

function log(msg) {
  const div = document.createElement("div");
  div.textContent = `${new Date().toLocaleTimeString()} â†’ ${msg}`;
  document.getElementById("log").prepend(div);
}

function startScanner() {
  if (scannerRunning) return;

  const isLaptop = !/Android|iPhone/i.test(navigator.userAgent);

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.getElementById("scanner"),
      constraints: {
        facingMode: isLaptop ? "user" : "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      area: {
        top: "25%",
        bottom: "25%",
        left: "10%",
        right: "10%"
      }
    },

    locator: {
      patchSize: "large",
      halfSample: false
    },

    numOfWorkers: navigator.hardwareConcurrency || 4,
    frequency: 30,

    decoder: {
      readers: [
        "ean_reader",
        "upc_reader",
        "code_128_reader",
        "code_39_reader"
      ]
    },

    locate: true
  }, err => {
    if (err) {
      alert("Camera permission error or HTTPS required.");
      return;
    }

    Quagga.start();
    scannerRunning = true;
    log("âœ… Scanner started");
  });

  Quagga.onDetected(onDetected);
}

// ðŸ§  AI RECOVERY LOGIC
function onDetected(data) {
  const code = data.codeResult.code;
  const confidence = data.codeResult.confidence;
  const now = Date.now();

  // Accept blurry scans
  if (confidence < 0.5) return;

  // AI buffer
  if (!aiMemory[code]) {
    aiMemory[code] = { count: 1, time: now };
    return;
  }

  if (now - aiMemory[code].time < 500) {
    aiMemory[code].count++;
  } else {
    aiMemory[code] = { count: 1, time: now };
    return;
  }

  // Require stability
  if (aiMemory[code].count < 2) return;

  // Prevent duplicate spam
  if (lastCode === code && now - lastScanTime < 1200) return;

  lastCode = code;
  lastScanTime = now;

  log(`âœ… SCANNED: ${code} (${Math.round(confidence * 100)}%)`);
}

function stopScanner() {
  if (!scannerRunning) return;
  Quagga.stop();
  scannerRunning = false;
  log("â›” Scanner stopped");
}
</script>

</body>
</html>

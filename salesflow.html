<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 12px; shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Big Boxes Styling */
        .stats-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-box { flex: 1; padding: 20px; border-radius: 10px; color: white; text-align: center; }
        .spend-box { background-color: #e74c3c; } /* Red for Spend */
        .earned-box { background-color: #2ecc71; } /* Green for Earned */
        .stat-box h3 { margin: 0; font-size: 0.9em; opacity: 0.9; }
        .stat-box p { margin: 10px 0 0; font-size: 1.8em; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid #ddd; }
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 80px; }
        .unit-input { width: 120px !important; }
        button { cursor: pointer; background: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Business Dashboard</h2>
    <div id="status">Checking authentication...</div>

    <div class="stats-container" id="statsArea" style="display:none;">
        <div class="stat-box spend-box">
            <h3>TOTAL SPEND</h3>
            <p id="totalSpend">0.00</p>
        </div>
        <div class="stat-box earned-box">
            <h3>TOTAL EARNED</h3>
            <p id="totalEarned">0.00</p>
        </div>
    </div>

    <table id="inventoryTable" style="display:none;">
        <thead>
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Cost Price</th>
                <th>Selling Price</th>
                <th>Unit (kg/box)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="inventoryBody"></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // INITIALIZE FIREBASE (Replace with your config)
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0",
  storageBucket: "scalevest-163a0.firebasestorage.app",
  messagingSenderId: "938358950124",
  appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
  measurementId: "G-QD3TWBZHR0"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  let currency = "$";
  let previousInventory = {};

  // 1. REGISTRATION LOGIC (Trigger this when user signs up)
  function registerBusinessOwner(uid, name, age, businessType, employees, selectedCurrency) {
    db.ref(`BusinessOwners/${uid}`).set({
      name,
      age,
      businessType,
      employees: employees || "N/A",
      nationalCurrency: selectedCurrency,
      totalEarned: 0, // Initialize earnings
      createdAt: new Date().toISOString()
    });
  }

  // 2. AUTH & DATA LOAD
  auth.onAuthStateChanged(u => {
    if (!u) return;

    // Fetch user settings (Currency & Total Earned)
    db.ref(`BusinessOwners/${u.uid}`).on('value', snap => {
        const userData = snap.val();
        currency = userData.nationalCurrency || "$";
        document.getElementById('totalEarned').innerText = `${currency} ${userData.totalEarned || 0}`;
    });

    // Fetch Inventory
    const invRef = db.ref(`Businesses/${u.uid}/inventory`);
    invRef.on("value", s => {
      const inventory = s.val() || {};
      
      // LOGIC: Check if quantity decreased to add to "Total Earned"
      handleSalesLogic(u.uid, inventory);
      
      render(u.uid, inventory);
      calculateTotalSpend(inventory);
      
      document.getElementById('status').style.display = "none";
      document.getElementById('statsArea').style.display = "flex";
      document.getElementById('inventoryTable').style.display = "table";
      
      previousInventory = JSON.parse(JSON.stringify(inventory)); // Deep copy
    });
  });

  // 3. SALES LOGIC (When Qty drops, increase Total Earned)
  function handleSalesLogic(uid, newInv) {
    Object.keys(newInv).forEach(key => {
        const oldQty = (previousInventory[key] && previousInventory[key].quantity) || 0;
        const newQty = newInv[key].quantity || 0;
        const sellPrice = newInv[key].sellingPrice || 0;

        if (newQty < oldQty) {
            const soldAmount = (oldQty - newQty) * sellPrice;
            db.ref(`BusinessOwners/${uid}/totalEarned`).transaction(current => (current || 0) + soldAmount);
        }
    });
  }

  // 4. CALCULATE TOTAL SPEND
  function calculateTotalSpend(inventory) {
    let total = 0;
    Object.values(inventory).forEach(item => {
        total += (Number(item.costPrice) || 0) * (Number(item.quantity) || 0);
    });
    document.getElementById('totalSpend').innerText = `${currency} ${total.toFixed(2)}`;
  }

  // 5. RENDER TABLE
  function render(uid, inventory) {
    const tbody = document.getElementById('inventoryBody');
    tbody.innerHTML = "";

    Object.keys(inventory).forEach(key => {
      const item = inventory[key];
      const row = `
        <tr>
          <td>${item.name || key}</td>
          <td>${item.quantity || 0}</td>
          <td><input type="number" id="cp-${key}" value="${item.costPrice || 0}"></td>
          <td><input type="number" id="sp-${key}" value="${item.sellingPrice || 0}"></td>
          <td><input type="text" id="unit-${key}" class="unit-input" placeholder="e.g. kg" value="${item.unit || ''}"></td>
          <td><button onclick="updateItem('${uid}', '${key}')">Save</button></td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
  }

  // 6. SAVE UPDATES
  window.updateItem = function(uid, key) {
    const cp = document.getElementById(`cp-${key}`).value;
    const sp = document.getElementById(`sp-${key}`).value;
    const unit = document.getElementById(`unit-${key}`).value;

    db.ref(`Businesses/${uid}/inventory/${key}`).update({
        costPrice: Number(cp),
        sellingPrice: Number(sp),
        unit: unit
    }).then(() => alert("Saved!"));
  };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Inventory Manager</title>
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --danger: #ef4444; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        h2 { margin-top: 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }

        /* KPI Boxes */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; border-radius: 10px; color: white; position: relative; }
        .spend-card { background: var(--danger); }
        .earned-card { background: var(--success); }
        .stat-card h3 { margin: 0; font-size: 0.85rem; text-transform: uppercase; opacity: 0.9; }
        .stat-card p { margin: 10px 0 0; font-size: 2rem; font-weight: bold; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.85rem; color: #64748b; border-bottom: 2px solid #edf2f7; }
        td { padding: 12px; border-bottom: 1px solid #edf2f7; }
        
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; width: 90px; outline: none; }
        input:focus { border-color: var(--primary); }
        .unit-input { width: 110px; }

        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-reset { background: #64748b; color: white; margin-top: 20px; font-size: 0.8rem; }
        .btn:hover { opacity: 0.9; }

        #currencyOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:1000; }
        .modal { background: white; padding: 30px; border-radius: 12px; text-align: center; }
    </style>
</head>
<body>

<div id="currencyOverlay">
    <div class="modal">
        <h3>Welcome!</h3>
        <p>Please enter your national currency symbol</p>
        <input type="text" id="userCurrency" placeholder="e.g. $, ₹, £, ₦" style="width: 150px; font-size: 1.5rem; text-align: center;"><br><br>
        <button class="btn btn-save" onclick="saveInitialCurrency()">Start Managing</button>
    </div>
</div>

<div class="container">
    <h2>Product Dashboard</h2>
    <div id="status">Authenticating...</div>

    <div id="mainUI" style="display:none;">
        <div class="stats-grid">
            <div class="stat-card spend-card">
                <h3>Total Spend (Cost of Goods)</h3>
                <p id="totalSpend">0.00</p>
            </div>
            <div class="stat-card earned-card">
                <h3>Total Earned (Revenue)</h3>
                <p id="totalEarned">0.00</p>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Qty</th>
                    <th>Cost Price</th>
                    <th>Selling Price</th>
                    <th>Unit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryBody"></tbody>
        </table>

        <button class="btn btn-reset" onclick="resetAccounting()">Reset Total Spend & Earned</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // 1. YOUR FIREBASE CONFIG
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
  authDomain: "scalevest-163a0.firebaseapp.com",
  databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
  projectId: "scalevest-163a0",
  storageBucket: "scalevest-163a0.firebasestorage.app",
  messagingSenderId: "938358950124",
  appId: "1:938358950124:web:043506aeaacea2a96bfdc9",
  measurementId: "G-QD3TWBZHR0"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentUID = null;
    let globalCurrency = "$";
    let previousInventory = {};

    // 2. AUTH LISTENER
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUID = user.uid;
            checkUserSetup();
        } else {
            document.getElementById('status').innerHTML = "Please Log In.";
        }
    });

    // 3. CHECK IF CURRENCY EXISTS
    function checkUserSetup() {
        db.ref(`BusinessOwners/${currentUID}`).on('value', snap => {
            const data = snap.val();
            if (!data || !data.nationalCurrency) {
                document.getElementById('currencyOverlay').style.display = 'flex';
            } else {
                document.getElementById('currencyOverlay').style.display = 'none';
                globalCurrency = data.nationalCurrency;
                startDashboard();
            }
        });
    }

    // 4. SAVE CURRENCY (Used during first setup)
    window.saveInitialCurrency = function() {
        const symbol = document.getElementById('userCurrency').value || "$";
        db.ref(`BusinessOwners/${currentUID}`).update({
            nationalCurrency: symbol,
            totalSpend: 0,
            totalEarned: 0,
            createdAt: new Date().toISOString()
        });
    }

    // 5. START DASHBOARD
    function startDashboard() {
        // Listen to Totals
        db.ref(`BusinessOwners/${currentUID}`).on('value', snap => {
            const data = snap.val() || {};
            document.getElementById('totalSpend').innerText = `${globalCurrency} ${Number(data.totalSpend || 0).toLocaleString()}`;
            document.getElementById('totalEarned').innerText = `${globalCurrency} ${Number(data.totalEarned || 0).toLocaleString()}`;
        });

        // Listen to Inventory
        const invRef = db.ref(`Businesses/${currentUID}/inventory`);
        
        // Initial Fetch to prevent math errors on first load
        invRef.once('value').then(snap => {
            previousInventory = snap.val() || {};
            
            invRef.on('value', s => {
                const currentInv = s.val() || {};
                processAccounting(currentInv); // Calculate Spend/Earned
                renderTable(currentInv);
                
                document.getElementById('status').style.display = 'none';
                document.getElementById('mainUI').style.display = 'block';
                
                // Save current state for next comparison
                previousInventory = JSON.parse(JSON.stringify(currentInv));
            });
        });
    }

    // 6. ACCOUNTING LOGIC (Spend vs Earned)
    function processAccounting(newInv) {
        const ownerRef = db.ref(`BusinessOwners/${currentUID}`);

        Object.keys(newInv).forEach(key => {
            const oldItem = previousInventory[key] || { quantity: 0 };
            const newItem = newInv[key];

            const oldQty = Number(oldItem.quantity) || 0;
            const newQty = Number(newItem.quantity) || 0;
            const cp = Number(newItem.costPrice) || 0;
            const sp = Number(newItem.sellingPrice) || 0;

            // IF QUANTITY INCREASED: Add to Total Spend
            if (newQty > oldQty) {
                const diff = newQty - oldQty;
                ownerRef.child('totalSpend').transaction(c => (c || 0) + (diff * cp));
            } 
            // IF QUANTITY DECREASED: Add to Total Earned
            else if (newQty < oldQty) {
                const diff = oldQty - newQty;
                ownerRef.child('totalEarned').transaction(c => (c || 0) + (diff * sp));
            }
        });
    }

    // 7. RENDER
    function renderTable(inventory) {
        const tbody = document.getElementById('inventoryBody');
        tbody.innerHTML = "";

        Object.keys(inventory).forEach(key => {
            const item = inventory[key];
            tbody.innerHTML += `
                <tr>
                    <td>${item.name || key}</td>
                    <td><strong>${item.quantity || 0}</strong></td>
                    <td><input type="number" id="cp-${key}" value="${item.costPrice || 0}"></td>
                    <td><input type="number" id="sp-${key}" value="${item.sellingPrice || 0}"></td>
                    <td><input type="text" id="unit-${key}" class="unit-input" placeholder="e.g. Per KG" value="${item.unit || ''}"></td>
                    <td><button class="btn btn-save" onclick="updateRates('${key}')">Save Rates</button></td>
                </tr>
            `;
        });
    }

    // 8. UPDATE RATES
    window.updateRates = function(key) {
        const cp = document.getElementById(`cp-${key}`).value;
        const sp = document.getElementById(`sp-${key}`).value;
        const unit = document.getElementById(`unit-${key}`).value;

        db.ref(`Businesses/${currentUID}/inventory/${key}`).update({
            costPrice: Number(cp),
            sellingPrice: Number(sp),
            unit: unit
        }).then(() => alert("Product rates updated!"));
    };

    // 9. RESET BUTTON
    window.resetAccounting = function() {
        if(confirm("Are you sure you want to reset your Spend and Earned totals to 0? This cannot be undone.")) {
            db.ref(`BusinessOwners/${currentUID}`).update({
                totalSpend: 0,
                totalEarned: 0
            });
        }
    }
</script>

</body>
</html>

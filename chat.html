<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Session | ScaleVest</title>
    <script src='https://8x8.vc/external_api.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.27/jsrsasign-all-min.js"></script>
    <style>
        body { font-family: 'SF Pro Display', -apple-system, sans-serif; background: #f8f9fa; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .chat-header {
            background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }
        .header-title { font-weight: 800; font-size: 1.2rem; color: #1a1a1a; }
        .header-sub { font-size: 0.85rem; color: #10b981; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 10px; }

        .action-btn {
            background: #f3f4f6; border: 1px solid #e5e7eb; padding: 8px 14px; border-radius: 8px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #374151;
            display: flex; align-items: center; gap: 6px; transition: 0.2s; text-decoration: none;
        }
        .meeting-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; display: none; }

        /* CHAT AREA */
        #chatContainer {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            position: relative; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;
        }

        /* MESSAGES */
        .message-bubble { max-width: 70%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s ease; word-wrap: break-word; }
        .msg-mine { background: #10b981; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-theirs { background: white; color: #374151; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timestamp { font-size: 10px; opacity: 0.7; margin-top: 5px; display: block; text-align: right; }
        
        .meeting-card { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; padding: 15px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .msg-theirs .meeting-card { background: #f0fdf4; border-color: #10b981; color: #064e3b; }
        .join-btn { background: #fff; color: #10b981; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; margin-top: 10px; cursor: pointer; width: 100%; }

        /* INPUT AREA */
        .input-area { background: white; padding: 15px 20px; display: flex; gap: 12px; border-top: 1px solid #e5e7eb; align-items: center; }
        #msgInput { flex: 1; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; outline: none; font-size: 16px; }
        #sendBtn { background: #10b981; color: white; border: none; padding: 0 25px; border-radius: 12px; font-weight: 700; cursor: pointer; height: 50px; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
        .modal-btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; width: 100%; }
        .btn-primary { background: #10b981; color: white; }

        /* VIDEO CONFERENCE */
        #videoConferenceContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; flex-direction: column; }
        #jitsiFrame { flex: 1; width: 100%; border: none; }
        #meetingLoader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3001; color: white; }
        .loader-spinner { width: 60px; height: 60px; border: 4px solid #333; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        .video-controls { height: 80px; background: #111; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; background: #333; color: white; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="uploadProgress" style="position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: #10b981; z-index: 200;"></div>

    <div class="chat-header">
        <div class="header-left">
            <img src="ScaleVestLogo.png" alt="SV" class="header-logo" onerror="this.src='https://via.placeholder.com/45?text=SV'"> 
            <div>
                <div class="header-title" id="chatTitle">Connecting...</div>
                <div class="header-sub">ScaleVest Secure Line</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="action-btn meeting-btn" id="meetingBtn" onclick="openMeetingModal()">Arrange Meeting</button>
            <button class="action-btn" onclick="history.back()">Back</button>
        </div>
    </div>

    <div id="chatContainer">
        <div id="initialLoader" style="position: absolute; top:0; left:0; width:100%; height:100%; background:#f8f9fa; z-index:50; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div class="loader-spinner"></div>
            <div style="margin-top:10px; color:#888;">Syncing Secure Line...</div>
        </div>
        <div class="typing-indicator" id="typingBubble" style="display:none; align-self:flex-start; padding:10px; background:white; border-radius:10px;">Typing...</div>
    </div>

    <div class="input-area">
        <button id="attachBtn" style="background:none; border:none; font-size:24px; cursor:pointer;">ðŸ“Ž</button>
        <input type="file" id="fileInput" style="display: none;">
        <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">SEND</button>
    </div>

    <div id="meetingSetupModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">Arrange Meeting</div>
            <input type="text" id="meetingTitle" class="modal-input" placeholder="Meeting Title (e.g. Portfolio Review)">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input type="date" id="meetingDate" class="modal-input">
                <input type="time" id="meetingTime" class="modal-input">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="modal-btn" onclick="closeMeetingModal()">Cancel</button>
                <button class="modal-btn btn-primary" onclick="createMeeting()">Generate Link</button>
            </div>
        </div>
    </div>

    <div id="videoConferenceContainer">
        <div id="jitsiFrame">
            <div id="meetingLoader">
                <div class="loader-spinner"></div>
                <div class="loader-text">Configuring Secure Session...</div>
            </div>
        </div>
        <div class="video-controls">
            <button class="control-btn" onclick="toggleAudio()" id="btnMic">ðŸŽ¤</button>
            <button class="control-btn" onclick="toggleVideo()" id="btnCam">ðŸ“·</button>
            <button class="control-btn" style="background:#ef4444;" onclick="leaveMeeting()">Leave</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD6PdrKp2XLfRqjC587lMpdKTaWD4MBens",
            authDomain: "scalevest-163a0.firebaseapp.com",
            databaseURL: "https://scalevest-163a0-default-rtdb.firebaseio.com",
            projectId: "scalevest-163a0",
            storageBucket: "scalevest-163a0.firebasestorage.app",
            appId: "1:938358950124:web:043506aeaacea2a96bfdc9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let currentUser, chatRoomID, jitsiAPI, isInvestor = false, userDisplayName = "User", userAvatar = "";
        let audioMuted = false, videoMuted = false;

        const params = new URLSearchParams(window.location.search);
        const recipientUID = params.get('recipient');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await identifyUserRole();
                initializeChat();
            } else { window.location.href = "login3.html"; }
        });

        async function identifyUserRole() {
            const invSnap = await get(ref(db, `investorProfiles/${currentUser.uid}`));
            if (invSnap.exists()) {
                isInvestor = true;
                document.getElementById('meetingBtn').style.display = 'block';
                userDisplayName = invSnap.val().fullName || "Investor";
                userAvatar = invSnap.val().photoURL || "";
            } else {
                const fndSnap = await get(ref(db, `founderProfile/${currentUser.uid}`));
                if (fndSnap.exists()) {
                    userDisplayName = fndSnap.val().founderUsername || "Founder";
                    userAvatar = fndSnap.val().photoURL || "";
                }
            }
        }

        // --- 1. JITSI TOKEN GENERATION ---
        window.generateJitsiToken = function(roomName) {
            const appId = "vpaas-magic-cookie-0fd84653e8f44399aba55f69eaf1f6fe";
            const kid = "e06cc7";
            
            const prvKeyPEM = `-----BEGIN RSA PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCytntDVcixIfHE
9WsWkCSbuX1Dyemm0beZCSXhvCesqNP0sdUP8gSskZzLPsRlH4iLJIOIg/m6nYcK
hDGUTivM1HLEb5pf3c38b1qDYGpjm67UFfv2l2/YeGuPkutUSjos90M3l0lHxeLR
YIxpbFCm8nYEBIvGHU6ifCODsfnvN9neR527ipf8rwUxm1TSPtWzr+EfI/+s9f/3
7DM+iXWD2lQLCQVOxBNlUOTCCkEzaIV8N2kwhHzCs1l3I7pQxEvQTxqZIeP12i2r
40/30IBeLAnfOHY3XeG6Y00typKHU6B1xqR8MCD8O2ALEb/9xGMEfRYQTSNCq6ve
9iGIGJ2fAgMBAAECggEAaiOc46nwLtuVJsAHYPgs9dvdfMRPo8cMPrTDLeU8vvvq
Hnr7qqO3iPJWaBOYOuLWiqUeBZc0W1QxntpSQ92Ff/pxSx9pVSR7sUBFRp+dsBkH
ZWjFI3hfcfZbE4NThtUq5gfYgQy19g2eH3IzEm3FHNIFq28zwG8pg7EsuouagCru
k3KpI/VxiYJ3YKpJpxOkdMw1Wce1bKGZdGcLi5Wsww/R0E2tpBVcqoJgYGUajQd5
LvJskxXpHbIfMZKuHt5wghLB0rZGla6bPrM4yb3r5uZf1qtBDHBFqfrQgL+yougG
JHbY7Z63HtQIl02tVowWJR8RZL0vd6kvwbYO4JfX6QKBgQD/DbudQU+kkQnmGFWv
ZQQITbSe32x+Ma5uyXfCV8UHsmXqBdXieIrHLJGmxYp++S3eMvPEjmZCO9TJFge3
/s79NL/ricMQVGP9cVCQQZAmIy0Nl1vgD1O5mBO9+KgfCJyXKBznCJPx34J4MCgE
hAoVQqKn/hVIFx2HaHpfD9WiGwKBgQCzYDwm8wjNyxQaoBxzqXr/bxfLuSfhbQbf
0t2YiZM5N2OjBeuEvrKTBl3DjHtEU/Vh1gDbHVEgm+8qT78pjjGwVv3N90qCEzls
VAYEBZRdK+0VmHumEYLTcG/WKf+M828pXrsMYVJRhso7yip+IShrW/4TC6gysUUM
auwQ7h5KzQKBgAo4QKZCcbCEZ0MjAnvurkSu6GfdR/megADMbdIJtkliqpa/+RwD
/HuSm5t1GuGPlnjqzb24fvx0bUhJa7HBsgWPUYlckcZbu03ydmnxVpdQnYOH5xSJ
SK+NGm1oQ0RLEgs0fkP7ogH1FMNAGrpjmAvWCbJ1ieDDnFlKpGyes861AoGAE0pe
LbIlWDxmxRZC+Q1Y9O91l6sp5sxa2OdMfYMOGjEivf18/qGjgrxEiSsqdoaw9PyW
yvm0J9WdOueon0dzgItacDQQBz0aB9RhcT1IX1zB+niTk6B+eU62OEn7+aSUZ9aQ
NxygRbRBO3zaZQYb2q/h+xpd1FXMHzHAgXGaQGECgYEArNdypdZIWNH8DmcH+vq3
J+gTaaH62Ipqts4l9mUsFvto2HVfA8Hcgsi2aNN+MBF6cytYVwVks99w1/hVOBe2
M7yVbIhkAg9PuZwxpYEaAW6lOU1aYh2xYfZigalUY45ivIbNmk/czaFJ8dXIe7M0
b3jwupOm6VFUtDOi4xuQ8VI=
-----END RSA PRIVATE KEY-----`;

            const keyObj = KEYUTIL.getKey(prvKeyPEM);
            const header = { alg: 'RS256', typ: 'JWT', kid: kid };
            const now = Math.floor(Date.now() / 1000);
            const payload = {
                aud: "jitsi", iss: "chat", sub: appId, room: roomName,
                iat: now, exp: now + 7200,
                context: { user: { name: userDisplayName, avatar: userAvatar, moderator: isInvestor } }
            };
            return KJUR.jws.JWS.sign("RS256", JSON.stringify(header), JSON.stringify(payload), keyObj);
        };

        // --- 2. MEETING JOIN LOGIC ---
        window.tryJoinMeeting = async (meetingId, scheduledTime) => {
            const room = "ScaleVest_" + meetingId;
            const token = generateJitsiToken(room);
            
            document.getElementById('videoConferenceContainer').style.display = 'flex';
            document.getElementById('meetingLoader').style.display = 'flex';

            const domain = "8x8.vc";
            const appId = "vpaas-magic-cookie-0fd84653e8f44399aba55f69eaf1f6fe";

            const options = {
                roomName: appId + "/" + room,
                jwt: token,
                width: "100%", height: "100%",
                parentNode: document.querySelector('#jitsiFrame'),
                userInfo: { displayName: userDisplayName },
                configOverwrite: { prejoinPageEnabled: false, enableLobby: false, startWithAudioMuted: false }
            };

            try {
                jitsiAPI = new JitsiMeetExternalAPI(domain, options);
                jitsiAPI.addEventListener('videoConferenceJoined', () => {
                    document.getElementById('meetingLoader').style.display = 'none';
                });
                jitsiAPI.addEventListener('videoConferenceLeft', () => window.leaveMeeting());
            } catch (e) { console.error(e); window.leaveMeeting(); }
        };

        // --- 3. UI CONTROLS ---
        window.openMeetingModal = () => document.getElementById('meetingSetupModal').style.display = 'flex';
        window.closeMeetingModal = () => document.getElementById('meetingSetupModal').style.display = 'none';

        window.toggleAudio = () => {
            if(jitsiAPI) { jitsiAPI.executeCommand('toggleAudio'); audioMuted = !audioMuted; document.getElementById('btnMic').classList.toggle('active', audioMuted); }
        };
        window.toggleVideo = () => {
            if(jitsiAPI) { jitsiAPI.executeCommand('toggleVideo'); videoMuted = !videoMuted; document.getElementById('btnCam').classList.toggle('active', videoMuted); }
        };
        window.leaveMeeting = () => {
            if(jitsiAPI) jitsiAPI.dispose();
            document.getElementById('videoConferenceContainer').style.display = 'none';
            location.reload(); // Refresh to clean up state
        };

        // --- 4. CHAT SYSTEM ---
        function initializeChat() {
            const ids = [currentUser.uid, recipientUID].sort();
            chatRoomID = `chat_${ids[0]}_${ids[1]}`;
            onChildAdded(ref(db, `Chats/${chatRoomID}`), (snap) => renderMessage(snap.val()));
            document.getElementById('initialLoader').style.display = 'none';
        }

        function renderMessage(msg) {
            if(!msg.sender) return;
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = `message-bubble ${msg.sender === currentUser.uid ? 'msg-mine' : 'msg-theirs'}`;
            
            if (msg.type === 'meeting') {
                div.innerHTML = `<div class="meeting-card"><strong>ðŸ“¹ Meeting: ${msg.title}</strong><br><button class="join-btn" onclick="tryJoinMeeting('${msg.meetingId}', 'now')">JOIN NOW</button></div>`;
            } else {
                div.textContent = msg.text;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        window.createMeeting = async () => {
            const mId = `meet_${Date.now()}`;
            const title = document.getElementById('meetingTitle').value || "ScaleVest Call";
            await push(ref(db, `Chats/${chatRoomID}`), {
                sender: currentUser.uid, type: 'meeting', title: title,
                meetingId: mId, timestamp: Date.now()
            });
            closeMeetingModal();
        };

        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            await push(ref(db, `Chats/${chatRoomID}`), { sender: currentUser.uid, text: val, timestamp: Date.now() });
            document.getElementById('msgInput').value = "";
        };

    </script>
</body>
</html>
